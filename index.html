<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>TerraLens AI | Gemini Edition</title>
   
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
   <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

   <style>
       :root {
           --primary: #ff4757;  
           --blue: #3742fa;
           --dark: #2f3542;
           --glass: rgba(255, 255, 255, 0.98);
           --shadow: 0 20px 40px rgba(0,0,0,0.12);
       }

       body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #f1f2f6; }
       #map { width: 100vw; height: 100vh; z-index: 0; opacity: 0; transition: opacity 1.5s ease; background: #a8edea; }
       .leaflet-routing-container { display: none !important; }

       @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
       @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
       @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
       
       .floating { animation: float 4s ease-in-out infinite; }
       .pulse-text { animation: pulse 1.5s infinite; }

       .window {
           opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.95);
           transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none;
       }
       .window.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }

       #welcome-screen {
           position: fixed; inset: 0; background: radial-gradient(circle at center, #ffffff 0%, #dfe4ea 100%);
           z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.8s;
       }
       .welcome-card { text-align: center; background: white; padding: 50px; border-radius: 40px; box-shadow: 0 30px 60px rgba(0,0,0,0.1); max-width: 450px; }

       button { border: none; outline: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
       button:hover { transform: scale(1.06); filter: brightness(1.05); }
       button:active { transform: scale(0.96); }

       .menu-btn {  
           background: var(--glass); padding: 14px 22px; border-radius: 20px; font-weight: 800; color: var(--dark);
           display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);
       }
       .menu-btn.active { background: var(--blue); color: white; box-shadow: 0 10px 20px rgba(55, 66, 250, 0.3); }

       .search-wrapper {
           position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
           z-index: 1000; display: flex; background: var(--glass); padding: 8px; border-radius: 50px; box-shadow: var(--shadow);
       }
       .search-input { border: none; background: transparent; padding: 0 20px; width: 300px; font-weight: 700; font-size: 16px; outline: none; }

       .side-menu { position: absolute; top: 100px; left: 25px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
       .glass-panel { background: var(--glass); backdrop-filter: blur(20px); border-radius: 30px; box-shadow: var(--shadow); border: 1px solid white; }

       #info-card { position: absolute; top: 25px; right: 25px; width: 340px; z-index: 1001; padding: 30px; }
       #chat-wrapper { position: absolute; bottom: 25px; left: 25px; width: 360px; z-index: 1001; }

       .bot-head {
           width: 80px; height: 70px; background: var(--primary); border-radius: 24px;
           border: 4px solid #fff; position: relative; display: flex; justify-content: center; align-items: center;
       }
       .bot-face { width: 55px; height: 35px; background: #2f3542; border-radius: 12px; display: flex; justify-content: center; align-items: center; gap: 8px; position: relative; overflow: hidden; }
       .bot-eye { width: 8px; height: 12px; background: #7bed9f; border-radius: 4px; box-shadow: 0 0 10px #7bed9f; animation: blink 4s infinite; }
       
       .blush { position: absolute; bottom: 3px; width: 14px; height: 8px; display: flex; gap: 2px; opacity: 0; transition: 0.5s; }
       .blush span { width: 2px; height: 100%; background: #ff4757; transform: rotate(20deg); border-radius: 5px; }
       .blush.left { left: 5px; } .blush.right { right: 5px; }
       .cute .blush { opacity: 0.8; }

       #chat-log { height: 300px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: rgba(241, 242, 246, 0.4); }
       .bubble { padding: 14px 18px; border-radius: 20px; font-size: 14px; font-weight: 700; max-width: 85%; line-height: 1.5; }
       .ai-msg { background: white; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
       .user-msg { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
       .typing::after { content: '|'; animation: blink 0.8s infinite; }

       #rating-widget {
           position: absolute; bottom: 25px; right: 25px; z-index: 1000;
           display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
       }
       .rating-bubble {
           background: white; padding: 15px 20px; border-radius: 25px; box-shadow: var(--shadow);
           max-width: 220px; font-size: 13px; font-weight: 800; color: var(--dark);
           position: relative; margin-bottom: 5px; transform-origin: bottom right; transition: 0.5s;
       }
       .rating-bubble::after {
           content: ''; position: absolute; bottom: -8px; right: 30px;
           border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white;
       }
       .vote-btns { display: flex; gap: 15px; margin-top: 10px; justify-content: center; }
       .vote-btns span { cursor: pointer; font-size: 24px; transition: 0.3s; }
       .vote-btns span:hover { transform: scale(1.3); }
   </style>
</head>
<body>

   <div id="welcome-screen">
       <div class="welcome-card floating">
           <div class="bot-head" style="width:110px; height:95px; margin: 0 auto 30px; border-radius: 30px;">
               <div class="bot-face" style="width:75px; height:50px;"><div class="bot-eye"></div><div class="bot-eye"></div></div>
           </div>
           <h1 style="font-weight:900; font-size: 38px; color: var(--dark); margin: 0;">TerraLens AI</h1>
           <p style="color: #747d8c; font-weight: 600; font-size: 16px; line-height: 1.6; margin: 20px 0 35px;">
               –ü—Ä–∏–≤–µ—Ç! –Ø TerraLens. –°–æ –º–Ω–æ–π —Ç—ã –Ω–∞–π–¥–µ—à—å –≥–æ—Ä—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–¥–æ–≤–æ–≥–æ –ò–ò.
           </p>
           <button onclick="startApp()" style="background: var(--primary); color: white; padding: 18px 45px; border-radius: 50px; font-weight: 900; font-size: 18px;">
               –ù–ê–ß–ê–¢–¨ –ü–£–¢–ï–®–ï–°–¢–í–ò–ï
           </button>
       </div>
   </div>

   <div id="map"></div>

   <div id="rating-widget" style="opacity:0; transition: 1s;">
       <div class="rating-bubble" id="rat-text">
           –û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à —Å–∞–π—Ç! –ü–æ–¥ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –º—ã –±—É–¥–µ–º —É–ª—É—á—à–∞—Ç—å –∏ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç!
           <div class="vote-btns" id="vote-controls">
               <span onclick="addVote('like')">üëç</span>
               <span onclick="addVote('dislike')">üëé</span>
           </div>
       </div>
       <div class="bot-head floating" id="rat-bot">
           <div class="bot-face">
               <div class="blush left"><span></span><span></span><span></span></div>
               <div class="bot-eye"></div><div class="bot-eye"></div>
               <div class="blush right"><span></span><span></span><span></span></div>
           </div>
       </div>
   </div>

   <div class="ui-
