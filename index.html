<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>TerraLens AI | Fixed Edition</title>

   

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>



  <style>

      :root {

          --primary: #ff4757;  

          --blue: #3742fa;

          --dark: #2f3542;

          --glass: rgba(255, 255, 255, 0.98);

          --shadow: 0 20px 40px rgba(0,0,0,0.12);

      }



      body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #f1f2f6; }

      #map { width: 100vw; height: 100vh; z-index: 0; opacity: 1; transition: opacity 0.5s; }



      /* –ê–ù–ò–ú–ê–¶–ò–ò */

      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

      @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }

      .floating { animation: float 4s ease-in-out infinite; }



      /* –ò–ù–§–û-–ö–ê–†–¢–û–ß–ö–ê */

      #info-card { position: absolute; top: 20px; right: 20px; width: 350px; z-index: 1001; padding: 25px; }

      .window {

          opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.95);

          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;

      }

      .window.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }



      .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }

      .stat-item { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 12px; }

      .stat-label { font-size: 10px; font-weight: 800; color: #a4b0be; text-transform: uppercase; }

      .stat-val { font-size: 13px; font-weight: 900; color: var(--dark); }



      /* –ß–ê–¢ */

      #chat-wrapper { position: absolute; bottom: 20px; left: 20px; width: 400px; z-index: 1001; }

      #chat-log { height: 350px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

      .bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; font-weight: 700; max-width: 85%; }

      .ai-msg { background: white; align-self: flex-start; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

      .user-msg { background: var(--blue); color: white; align-self: flex-end; }



      /* –ü–û–ò–°–ö */

      .search-wrapper {

          position: absolute; top: 20px; left: 50%; transform: translateX(-50%);

          z-index: 1000; display: flex; background: var(--glass); padding: 6px; border-radius: 50px; box-shadow: var(--shadow);

      }

      .search-input { border: none; background: transparent; padding: 0 20px; width: 250px; font-weight: 700; outline: none; }



      /* –ú–ï–ù–Æ */

      .side-menu-btns { position: absolute; top: 80px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }

      .menu-btn { background: var(--glass); padding: 12px 18px; border-radius: 18px; font-weight: 800; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; }

      .menu-btn.active { background: var(--blue) !important; color: white !important; }



      .main-side-menu {

          position: fixed; top: 0; left: -320px; width: 280px; height: 100vh;

          background: white; z-index: 2000; transition: 0.4s; padding: 25px; box-sizing: border-box;

      }

      .main-side-menu.open { left: 0; }

      .menu-link { 

          display: block; width: 100%; box-sizing: border-box; 

          padding: 15px; margin-bottom: 10px; border-radius: 15px; 

          background: #f8f9fa; text-decoration: none; color: var(--dark); font-weight: 800; border: none; text-align: left; cursor: pointer;

      }



      /* –ú–û–î–ê–õ–ö–ò (–§–ò–ö–°) */

      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 3000; display: none; opacity: 0; transition: 0.3s; }

      .modal-overlay.show { display: block; opacity: 1; }

      

      .custom-modal {

          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);

          background: white; padding: 30px; border-radius: 30px; width: 320px;

          z-index: 3001; display: none; text-align: center; box-shadow: var(--shadow); transition: 0.3s;

      }

      .custom-modal.show { display: block !important; transform: translate(-50%, -50%) scale(1); }



      /* –ë–û–¢ (–ú–ê–°–ö–û–¢) */

      .bot-head { width: 70px; height: 60px; background: var(--primary); border-radius: 20px; border: 3px solid #fff; display: flex; justify-content: center; align-items: center; margin: 0 auto; }

      .bot-face { width: 45px; height: 30px; background: #2f3542; border-radius: 10px; display: flex; justify-content: center; align-items: center; gap: 5px; overflow: hidden; }

      .bot-eye { width: 6px; height: 10px; background: #7bed9f; border-radius: 3px; animation: blink 4s infinite; }

  </style>

</head>

<body>



  <div id="map"></div>



  <div class="search-wrapper">

      <input type="text" id="global-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞...">

      <button onclick="globalSearch()" style="background:var(--primary); color:white; padding:10px 20px; border-radius:50px; font-weight:900; border:none; cursor:pointer;">–ù–ê–ô–¢–ò</button>

  </div>



  <div class="side-menu-btns">

      <button class="menu-btn" onclick="openMenu()">‚ò∞ –ú–ï–ù–Æ</button>

      <button class="menu-btn active" id="btn-map" onclick="setMode('map')">üó∫Ô∏è –ö–ê–†–¢–ê</button>

      <button class="menu-btn" id="btn-sat" onclick="setMode('sat')">üõ∞Ô∏è –°–ü–£–¢–ù–ò–ö</button>

      <button class="menu-btn" id="btn-route" onclick="toggleRoutePanel()">üö© –ü–£–¢–¨</button>

      <button class="menu-btn" style="background:var(--primary); color:white;" onclick="toggleChat()">ü§ñ –ß–ê–¢</button>

  </div>



  <div id="info-card" class="glass-panel window floating">

      <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">

          <img id="card-flag" src="" style="width:50px; border-radius:8px; display:none; border:1px solid #eee;">

          <div>

              <h2 id="card-city" style="margin:0; font-size:22px; font-weight:900;">–ì–æ—Ä–æ–¥</h2>

              <div id="card-country" style="opacity:0.6; font-size:14px; font-weight:800;">–°—Ç—Ä–∞–Ω–∞</div>

          </div>

      </div>

      <div class="stat-grid">

          <div class="stat-item"><div class="stat-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div><div id="card-temp" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">–ú–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è</div><div id="card-time" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">–í–∞–ª—é—Ç–∞</div><div id="card-curr" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div><div id="card-utc" class="stat-val">--</div></div>

      </div>

      <div id="card-wiki" style="font-size:13px; line-height:1.5; color:#57606f; max-height:100px; overflow-y:auto;"></div>

      <button onclick="closeWindow('info-card')" style="width:100%; margin-top:15px; padding:12px; border-radius:15px; background:#eee; font-weight:800; border:none; cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>

  </div>



  <div id="chat-wrapper" class="window">

      <div class="bot-head floating" style="margin-bottom:-10px; z-index:11;"><div class="bot-face"><div class="bot-eye"></div><div class="bot-eye"></div></div></div>

      <div class="glass-panel" style="overflow:hidden; border-radius:30px; background:var(--glass); backdrop-filter:blur(10px); border:1px solid white;">

          <div id="chat-log"></div>

          <div style="padding:15px; background:white; display:flex; gap:10px;">

              <input type="text" id="chat-input" placeholder="–°–ø—Ä–æ—Å–∏ TerraBot..." style="flex:1; border:none; outline:none; font-weight:700;">

              <button onclick="sendChat()" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:50%; border:none; cursor:pointer;">‚û§</button>

          </div>

      </div>

  </div>



  <div id="main-menu" class="main-side-menu">

      <h2 style="font-weight:900; margin-bottom:30px;">TerraLens</h2>

      <button class="menu-link" onclick="openModal('modal-donate')">üíñ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∞–π—Ç–∞</button>

      <a href="https://t.me/your_channel" target="_blank" class="menu-link">‚úàÔ∏è –¢–≥ –∫–∞–Ω–∞–ª –ø—Ä–æ–µ–∫—Ç–∞</a>

      <button class="menu-link" onclick="openModal('modal-settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>

      <button onclick="closeMenu()" style="margin-top:20px; background:none; border:none; color:#aaa; font-weight:700; cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>

  </div>



  <div id="modal-overlay" class="modal-overlay" onclick="closeAllModals()"></div>



  <div id="modal-donate" class="custom-modal">

      <div class="bot-head floating" style="margin-bottom:15px;">

          <div class="bot-face"><div class="bot-eye"></div><div class="bot-eye"></div></div>

      </div>

      <h3 style="margin-bottom:10px;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h3>

      <p style="font-size:14px; font-weight:700; color:#666; margin-bottom:20px;">–ü–æ–º–æ–≥–∏ –Ω–∞–º —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ò–ò –∏ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä—ã!</p>

      <a href="https://pay.cloudtips.ru/p/69a37267" target="_blank" style="background:var(--primary); color:white; display:block; padding:15px; border-radius:15px; text-decoration:none; font-weight:900;">–û–¢–ü–†–ê–í–ò–¢–¨ –î–û–ù–ê–¢ ‚ù§Ô∏è</a>

      <button onclick="closeAllModals()" style="margin-top:15px; border:none; background:none; color:#aaa; cursor:pointer; font-weight:700;">–ü–æ–∑–∂–µ</button>

  </div>



  <div id="modal-settings" class="custom-modal">

      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

      <p>–¢—É—Ç –±—É–¥—É—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>

      <button onclick="closeAllModals()" class="menu-link" style="text-align:center;">–û–ö</button>

  </div>



  <script>

      let map, tileLayer, routing;



      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã

      window.onload = () => {

          map = L.map('map', { center: [20, 0], zoom: 3, zoomControl: false, attributionControl: false });

          tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

          map.on('click', e => fetchInfo(e.latlng.lat, e.latlng.lng));

          addMsg("–ü—Ä–∏–≤–µ—Ç! –Ø TerraBot. –ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É /ali09", "ai");

      };



      // –ü–û–ò–°–ö (–° –æ—á–∏—Å—Ç–∫–æ–π)

      async function globalSearch() {

          const inp = document.getElementById('global-search');

          const q = inp.value;

          if(!q) return;

          const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`).then(res => res.json());

          if(r[0]) {

              map.flyTo([r[0].lat, r[0].lon], 10);

              fetchInfo(r[0].lat, r[0].lon);

              inp.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞

          }

      }



      // –î–ê–ù–ù–´–ï –ú–ï–°–¢–ê (–í—Å—ë –Ω–∞ –º–µ—Å—Ç–µ)

      async function fetchInfo(lat, lon) {

          document.getElementById('info-card').classList.add('active');

          const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`).then(r=>r.json());

          const city = geo.address.city || geo.address.town || geo.address.village || "–ú–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ";

          const country = geo.address.country || "–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞";

          

          document.getElementById('card-city').innerText = city;

          document.getElementById('card-country').innerText = country;

          document.getElementById('card-utc').innerText = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;



          // –§–ª–∞–≥ –∏ –í–∞–ª—é—Ç–∞

          const countryCode = geo.address.country_code?.toUpperCase();

          if(countryCode) {

              const cData = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`).then(r=>r.json());

              if(cData[0]) {

                  document.getElementById('card-flag').src = cData[0].flags.png;

                  document.getElementById('card-flag').style.display = 'block';

                  const curr = Object.keys(cData[0].currencies)[0];

                  document.getElementById('card-curr').innerText = `${curr} (${cData[0].currencies[curr].symbol})`;

              }

          }



          // –ü–æ–≥–æ–¥–∞ –∏ –í—Ä–µ–º—è

          const weather = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(r=>r.json());

          document.getElementById('card-temp').innerText = weather.current_weather.temperature + "¬∞C";

          document.getElementById('card-time').innerText = new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});



          // –í–∏–∫–∏

          const wiki = await fetch(`https://ru.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(city)}`).then(r=>r.json());

          document.getElementById('card-wiki').innerText = wiki.extract || "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç.";

      }



      // –ß–ê–¢

      async function sendChat() {

          const inp = document.getElementById('chat-input');

          const q = inp.value.trim();

          if(!q) return;



          addMsg(q, 'user');

          inp.value = '';



          if(q.toLowerCase() === '/ali09') {

              addMsg("üîì –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω. –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–Ω—ã!", "ai");

              return;

          }



          try {

              const res = await fetch("/api/chat", {

                  method: "POST",

                  headers: { "Content-Type": "application/json" },

                  body: JSON.stringify({ prompt: `–¢—ã TerraBot, –∫—Ä–∞—Ç–∫–æ –æ—Ç–≤–µ—Ç—å: ${q}` })

              });

              const data = await res.json();

              addMsg(data.choices[0].message.content, "ai");

          } catch(e) { addMsg("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ò–ò.", "ai"); }

      }



      function addMsg(text, type) {

          const log = document.getElementById('chat-log');

          const b = document.createElement('div');

          b.className = `bubble ${type}-msg`;

          b.innerText = text;

          log.appendChild(b);

          log.scrollTop = log.scrollHeight; // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑

      }



      // –õ–û–ì–ò–ö–ê –û–ö–ù (–§–ò–ö–° –ë–õ–Æ–†–ê)

      function openMenu() { document.getElementById('main-menu').classList.add('open'); }

      function closeMenu() { document.getElementById('main-menu').classList.remove('open'); }



      function openModal(id) {

          closeMenu();

          const overlay = document.getElementById('modal-overlay');

          const modal = document.getElementById(id);

          overlay.style.display = 'block';

          modal.style.display = 'block';

          setTimeout(() => {

              overlay.classList.add('show');

              modal.classList.add('show');

          }, 10);

      }



      function closeAllModals() {

          const overlay = document.getElementById('modal-overlay');

          const modals = document.querySelectorAll('.custom-modal');

          overlay.classList.remove('show');

          modals.forEach(m => m.classList.remove('show'));

          setTimeout(() => {

              overlay.style.display = 'none';

              modals.forEach(m => m.style.display = 'none');

          }, 300);

      }



      function toggleChat() { document.getElementById('chat-wrapper').classList.toggle('active'); }

      function closeWindow(id) { document.getElementById(id).classList.remove('active'); }

      function setMode(m) {

          document.getElementById('btn-map').classList.toggle('active', m==='map');

          document.getElementById('btn-sat').classList.toggle('active', m==='sat');

          tileLayer.setUrl(m==='sat'?'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}':'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

      }

  </script>

</body>

</html>

