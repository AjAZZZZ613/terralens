<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>TerraLens AI | Gemini Edition</title>

   

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>



  <style>

      :root {

          --primary: #ff4757;  

          --blue: #3742fa;

          --dark: #2f3542;

          --glass: rgba(255, 255, 255, 0.98);

          --shadow: 0 20px 40px rgba(0,0,0,0.12);

      }



      body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #f1f2f6; }

      #map { width: 100vw; height: 100vh; z-index: 0; opacity: 0; transition: opacity 1.5s ease; background: #a8edea; }

      .leaflet-routing-container { display: none !important; }



      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

      @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }

      @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

       

      .floating { animation: float 4s ease-in-out infinite; }

      .pulse-text { animation: pulse 1.5s infinite; }



      .window {

          opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.95);

          transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none;

      }

      .window.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }



      #welcome-screen {

          position: fixed; inset: 0; background: radial-gradient(circle at center, #ffffff 0%, #dfe4ea 100%);

          z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.8s;

      }

      .welcome-card { text-align: center; background: white; padding: 50px; border-radius: 40px; box-shadow: 0 30px 60px rgba(0,0,0,0.1); max-width: 450px; }



      button { border: none; outline: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }

      button:hover { transform: scale(1.06); filter: brightness(1.05); }

      button:active { transform: scale(0.96); }



      .menu-btn {  

          background: var(--glass); padding: 14px 22px; border-radius: 20px; font-weight: 800; color: var(--dark);

          display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);

      }

      .menu-btn.active { background: var(--blue); color: white; box-shadow: 0 10px 20px rgba(55, 66, 250, 0.3); }



      .search-wrapper {

          position: absolute; top: 25px; left: 50%; transform: translateX(-50%);

          z-index: 1000; display: flex; background: var(--glass); padding: 8px; border-radius: 50px; box-shadow: var(--shadow);

      }

      .search-input { border: none; background: transparent; padding: 0 20px; width: 300px; font-weight: 700; font-size: 16px; outline: none; }



      .side-menu-btns { position: absolute; top: 100px; left: 25px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }

      .glass-panel { background: var(--glass); backdrop-filter: blur(20px); border-radius: 30px; box-shadow: var(--shadow); border: 1px solid white; }



      #info-card { position: absolute; top: 25px; right: 25px; width: 340px; z-index: 1001; padding: 30px; }

      #chat-wrapper { position: absolute; bottom: 25px; left: 25px; width: 360px; z-index: 1001; }



      .bot-head {

          width: 80px; height: 70px; background: var(--primary); border-radius: 24px;

          border: 4px solid #fff; position: relative; display: flex; justify-content: center; align-items: center;

      }

      .bot-face { width: 55px; height: 35px; background: #2f3542; border-radius: 12px; display: flex; justify-content: center; align-items: center; gap: 8px; position: relative; overflow: hidden; }

      .bot-eye { width: 8px; height: 12px; background: #7bed9f; border-radius: 4px; box-shadow: 0 0 10px #7bed9f; animation: blink 4s infinite; }

       

      .blush { position: absolute; bottom: 3px; width: 14px; height: 8px; display: flex; gap: 2px; opacity: 0; transition: 0.5s; }

      .blush span { width: 2px; height: 100%; background: #ff4757; transform: rotate(20deg); border-radius: 5px; }

      .blush.left { left: 5px; } .blush.right { right: 5px; }

      .cute .blush { opacity: 0.8; }



      #chat-log { height: 300px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: rgba(241, 242, 246, 0.4); }

      .bubble { padding: 14px 18px; border-radius: 20px; font-size: 14px; font-weight: 700; max-width: 85%; line-height: 1.5; }

      .ai-msg { background: white; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }

      .user-msg { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }

      .typing::after { content: '|'; animation: blink 0.8s infinite; }



      #rating-widget {

          position: absolute; bottom: 25px; right: 25px; z-index: 1000;

          display: flex; flex-direction: column; align-items: flex-end; gap: 10px;

      }

      .rating-bubble {

          background: white; padding: 15px 20px; border-radius: 25px; box-shadow: var(--shadow);

          max-width: 220px; font-size: 13px; font-weight: 800; color: var(--dark);

          position: relative; margin-bottom: 5px; transform-origin: bottom right; transition: 0.5s;

      }

      .rating-bubble::after {

          content: ''; position: absolute; bottom: -8px; right: 30px;

          border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white;

      }

      .vote-btns { display: flex; gap: 15px; margin-top: 10px; justify-content: center; }

      .vote-btns span { cursor: pointer; font-size: 24px; transition: 0.3s; }

      .vote-btns span:hover { transform: scale(1.3); }



      /* --- –ù–û–í–û–ï: –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –ò –ú–û–î–ê–õ–ö–ò --- */

      #menu-toggle-btn {

          position: absolute;

          top: 25px;

          left: 25px;

          background: #fff;

          border: 2px solid #eee;

          padding: 12px 18px;

          border-radius: 20px;

          cursor: pointer;

          font-weight: 800;

          font-size: 14px;

          color: var(--dark);

          z-index: 1500;

          box-shadow: 0 4px 15px rgba(0,0,0,0.05);

          transition: 0.2s;

          display: flex;

          align-items: center;

          gap: 8px;

      }

      #menu-toggle-btn:hover { background: #f9f9f9; transform: scale(1.05); }



      .main-side-menu {

          position: fixed;

          top: 0; left: -320px;

          width: 280px;

          height: 100vh;

          background: #ffffff;

          box-shadow: 5px 0 30px rgba(0,0,0,0.15);

          z-index: 2000;

          transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);

          padding: 25px;

          display: flex;

          flex-direction: column;

      }

      .main-side-menu.open { left: 0; }



      .close-menu-btn {

          align-self: flex-end;

          background: none; border: none;

          font-size: 24px; cursor: pointer; color: #888;

      }

      .menu-title { font-size: 24px; font-weight: 900; color: var(--dark); margin-bottom: 30px; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; }



      .menu-links button, .menu-link {

          display: block; width: 100%;

          text-align: left;

          background: #fdfdfd; border: 1px solid #f1f2f6;

          padding: 16px; margin-bottom: 12px;

          border-radius: 15px; font-size: 15px; font-weight: 700;

          color: #444; text-decoration: none; cursor: pointer;

          transition: background 0.2s, transform 0.2s;

      }

      .menu-links button:hover, .menu-link:hover { background: #f0f8ff; transform: translateX(5px); border-color: var(--blue); }



      .modal-overlay {

          position: fixed; top: 0; left: 0; width: 100%; height: 100%;

          background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);

          z-index: 3000; display: none; opacity: 0; transition: opacity 0.3s;

      }

      .modal-overlay.show { display: block; opacity: 1; }



      .custom-modal {

          position: fixed; top: 50%; left: 50%;

          transform: translate(-50%, -50%) scale(0.8);

          background: white; padding: 30px; border-radius: 25px;

          width: 90%; max-width: 360px; text-align: center;

          box-shadow: 0 20px 50px rgba(0,0,0,0.2);

          z-index: 3001; display: none; opacity: 0;

          transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;

      }

      .custom-modal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }

      .custom-modal h3 { margin-top: 0; color: var(--dark); font-weight: 900; font-size: 22px; }

      .custom-modal p { color: #57606f; font-weight: 600; font-size: 14px; line-height: 1.5; margin-bottom: 25px; }



      .modal-btns { display: flex; gap: 10px; justify-content: center; }

      .btn-heart { background: var(--primary); color: #fff; padding: 14px 20px; border-radius: 12px; text-decoration: none; font-weight: 800; flex: 1; transition: 0.2s; }

      .btn-heart:hover { background: #e83e3e; transform: scale(1.05); }

      .btn-skip { background: none; border: none; color: #a4b0be; cursor: pointer; padding: 10px; font-weight: 700; font-size: 14px; }

      .btn-skip:hover { color: #57606f; }

      .btn-setting { background: #f1f2f6; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 800; color: var(--dark); transition: 0.2s; }

      .btn-setting:hover { background: #dfe4ea; }



  </style>

</head>

<body>



  <div id="welcome-screen">

      <div class="welcome-card floating">

          <div class="bot-head" style="width:110px; height:95px; margin: 0 auto 30px; border-radius: 30px;">

              <div class="bot-face" style="width:75px; height:50px;"><div class="bot-eye"></div><div class="bot-eye"></div></div>

          </div>

          <h1 style="font-weight:900; font-size: 38px; color: var(--dark); margin: 0;">TerraLens AI</h1>

          <p style="color: #747d8c; font-weight: 600; font-size: 16px; line-height: 1.6; margin: 20px 0 35px;">

              –ü—Ä–∏–≤–µ—Ç! –Ø TerraLens. –°–æ –º–Ω–æ–π —Ç—ã –Ω–∞–π–¥–µ—à—å –≥–æ—Ä—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–¥–æ–≤–æ–≥–æ –ò–ò.

          </p>

          <button onclick="startApp()" style="background: var(--primary); color: white; padding: 18px 45px; border-radius: 50px; font-weight: 900; font-size: 18px;">

              –ù–ê–ß–ê–¢–¨ –ü–£–¢–ï–®–ï–°–¢–í–ò–ï

          </button>

      </div>

  </div>



  <div id="map"></div>



  <button id="menu-toggle-btn" class="ui-element" style="opacity:0;" onclick="openMenu()">‚ò∞ –ú–ï–ù–Æ</button>



  <div id="rating-widget" style="opacity:0; transition: 1s;">

      <div class="rating-bubble" id="rat-text">

          –û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à —Å–∞–π—Ç! –ü–æ–¥ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ –º—ã –±—É–¥–µ–º —É–ª—É—á—à–∞—Ç—å –∏ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç!

          <div class="vote-btns" id="vote-controls">

              <span onclick="addVote('like')">üëç</span>

              <span onclick="addVote('dislike')">üëé</span>

          </div>

      </div>

      <div class="bot-head floating" id="rat-bot">

          <div class="bot-face">

              <div class="blush left"><span></span><span></span><span></span></div>

              <div class="bot-eye"></div><div class="bot-eye"></div>

              <div class="blush right"><span></span><span></span><span></span></div>

          </div>

      </div>

  </div>



  <div class="ui-element search-wrapper" id="ui-search" style="opacity:0;">

      <input type="text" class="search-input" id="global-search" placeholder="–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏–º—Å—è?">

      <button onclick="globalSearch()" style="background: var(--primary); color: white; padding: 12px 25px; border-radius: 50px; font-weight: 900;">–ü–û–ò–°–ö</button>

  </div>



  <div class="ui-element side-menu-btns" id="ui-menu" style="opacity:0;">

      <button class="menu-btn active" id="btn-map" onclick="setMode('map')">üó∫Ô∏è –ö–ê–†–¢–ê</button>

      <button class="menu-btn" id="btn-sat" onclick="setMode('sat')">üõ∞Ô∏è –°–ü–£–¢–ù–ò–ö</button>

      <button class="menu-btn" id="btn-route" onclick="toggleRoutePanel()">üö© –ú–ê–†–®–†–£–¢–´</button>

      <div id="route-panel" class="glass-panel" style="display:none; flex-direction:column; gap:10px; padding:20px; margin-top:10px;">

          <input type="text" id="start-inp" placeholder="–¢–æ—á–∫–∞ –ê" style="padding:12px; border-radius:15px; border:1px solid #eee;">

          <input type="text" id="end-inp" placeholder="–¢–æ—á–∫–∞ –ë" style="padding:12px; border-radius:15px; border:1px solid #eee;">

          <div style="display:flex; gap:10px;">

              <button onclick="buildRoute()" style="flex:1; background:var(--blue); color:white; padding:12px; border-radius:15px; font-weight:900;">–ü–£–¢–¨</button>

              <button onclick="clearRoute()" class="menu-btn" style="padding:12px;">‚úñ</button>

          </div>

      </div>

      <button class="menu-btn" style="background:var(--primary); color:white;" onclick="toggleChat()">ü§ñ AI TERRABOT</button>

  </div>



  <div id="info-card" class="glass-panel window">

      <div id="info-content">

          <div style="display:flex; align-items:center; gap:20px;">

              <img id="card-flag" src="" style="width:60px; border-radius:10px; display:none;">

              <div>

                  <h2 id="card-city" style="margin:0; font-size:26px; font-weight:900;">--</h2>

                  <div id="card-country" style="opacity:0.6; font-weight:800;">--</div>

              </div>

          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin:20px 0;">

              <div><div style="font-size:11px; font-weight:800; color:#a4b0be;">–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê</div><div id="card-temp" style="font-size:18px; font-weight:900; color:var(--primary);">--</div></div>

              <div style="text-align:right;"><div style="font-size:11px; font-weight:800; color:#a4b0be;">–í–†–ï–ú–Ø</div><div id="card-time" style="font-size:18px; font-weight:900;">--</div></div>

              <div><div style="font-size:11px; font-weight:800; color:#a4b0be;">–í–ê–õ–Æ–¢–ê</div><div id="card-curr" style="font-size:14px; font-weight:900; color:var(--primary);">--</div></div>

              <div style="text-align:right;"><div style="font-size:11px; font-weight:800; color:#a4b0be;">UTC</div><div id="card-utc" style="font-size:18px; font-weight:900;">--</div></div>

          </div>

          <div id="card-wiki" style="font-size:14px; color:#57606f; line-height:1.6; max-height:150px; overflow-y:auto; padding:15px; background:rgba(0,0,0,0.03); border-radius:20px;"></div>

      </div>

      <button onclick="closeWindow('info-card')" style="width:100%; margin-top:25px; padding:15px; border-radius:20px; background:#dfe4ea; font-weight:800; color:var(--dark);">–ó–ê–ö–†–´–¢–¨</button>

  </div>



  <div id="chat-wrapper" class="window">

      <div class="bot-head floating" style="margin-bottom: -15px; margin-left: 30px; z-index:10;">

          <div class="bot-face"><div class="bot-eye"></div><div class="bot-eye"></div></div>

      </div>

      <div class="glass-panel" style="overflow:hidden; display:flex; flex-direction:column;">

          <div style="padding:45px 20px 20px; text-align:center; font-weight:900; color:var(--primary); background:white;">TerraBot Gemini</div>

           

          <div id="chat-log"></div>

           

          <div id="loader" class="pulse-text" style="display: none; color: var(--primary); padding: 5px 20px; font-size: 13px; font-weight: 800; text-align: center; background: white;">

               ‚ö° –¢–µ—Ä—Ä–∞–ë–æ—Ç –¥—É–º–∞–µ—Ç...

          </div>



          <div style="padding:15px; background:white; display:flex; gap:10px; border-top:1px solid #f1f2f6;">

              <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ò–ò..." style="flex:1; border:none; outline:none; font-weight:700; font-family:inherit;">

              <button onclick="sendChat()" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:50%; font-size:20px;">‚û§</button>

          </div>

      </div>

  </div>



  <div id="main-menu" class="main-side-menu">

      <button class="close-menu-btn" onclick="closeMenu()">‚úñ</button>

      <div class="menu-title">TerraLens</div>

      

      <div class="menu-links">

          <button onclick="openModal('modal-donate')">üíñ 1. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∞–π—Ç–∞</button>

          <a href="https://t.me/terralensed" target="_blank" class="menu-link">‚úàÔ∏è 2. –¢–≥ –∫–∞–Ω–∞–ª —Å–∞–π—Ç–∞</a>

          <button onclick="openModal('modal-settings')">‚öôÔ∏è 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>

          <button onclick="openModal('modal-future')">üöÄ 4. –ë—É–¥—É—â–µ–µ —Å–∞–π—Ç–∞</button>

      </div>

  </div>



  <div id="modal-overlay" class="modal-overlay" onclick="closeAllModals()"></div>



  <div id="modal-donate" class="custom-modal">

      <img src="mascot.png" alt="Mascot" style="width: 80px; margin-bottom: 15px;">

      <h3>–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h3>

      <p>–ú–æ–∂–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–∞–π—Ç –∫–æ–ø–µ–µ—á–∫–æ–π. –í—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–¥—É—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É —Å–µ—Ä–≤–µ—Ä–∞ –∏ API.</p>

      <div class="modal-btns">

          <a href="https://pay.cloudtips.ru/p/69a37267" target="_blank" class="btn-heart" onclick="closeAllModals()">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å ‚ù§Ô∏è</a>

          <button class="btn-skip" onclick="closeAllModals()">–í–æ–∑–¥–µ—Ä–∂–∞—Ç—å—Å—è</button>

      </div>

  </div>



  <div id="modal-settings" class="custom-modal">

      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∞</h3>

      <p>–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å–∞–π—Ç:</p>

      <div class="modal-btns" style="flex-direction: column;">

          <button class="btn-setting" onclick="setView('desktop')">üíª –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è (–ë–∞–∑–æ–≤–∞—è)</button>

          <button class="btn-setting" onclick="setView('mobile')">üì± –¢–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</button>

      </div>

      <button class="btn-skip" onclick="closeAllModals()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>

  </div>



  <div id="modal-future" class="custom-modal">

      <h3>–ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ</h3>

      <ul style="text-align: left; font-size: 15px; font-weight: 600; color: #57606f; margin-bottom: 25px; line-height: 1.6;">

          <li>–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ò–ò –º–æ–¥–µ–ª–µ–π</li>

          <li>–ì–æ–ª–æ—Å–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –º–∞—Å–∫–æ—Ç–æ–º</li>

          <li>–õ–∏—á–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>

      </ul>

      <button class="btn-skip" onclick="closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>

  </div>



  <script>

      // --- –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE ---

      const firebaseConfig = {

          apiKey: "AIzaSyAYSeXH7-5Y6iEVO0uPWiVeeICyImayWn4",

          authDomain: "terralens-votes.firebaseapp.com",

          databaseURL: "https://terralens-votes-default-rtdb.europe-west1.firebasedatabase.app",

          projectId: "terralens-votes",

          storageBucket: "terralens-votes.firebasestorage.app",

          messagingSenderId: "306757191202",

          appId: "1:306757191202:web:d9c18b023254b235bfec7b"

      };

      firebase.initializeApp(firebaseConfig);

      const db = firebase.database();

      let stats = { likes: 0, dislikes: 0 };

      db.ref('votes').on('value', (s) => { if(s.exists()) stats = s.val(); });



      let map, tileLayer, routingControl;



      function startApp() {

          document.getElementById('welcome-screen').style.opacity = '0';

          setTimeout(() => {

              document.getElementById('welcome-screen').style.display = 'none';

              document.getElementById('map').style.opacity = '1';

              document.getElementById('ui-search').style.opacity = '1';

              document.getElementById('ui-menu').style.opacity = '1';

              document.getElementById('rating-widget').style.opacity = '1';

              document.getElementById('menu-toggle-btn').style.opacity = '1'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é

              initMap();

              typeMessage("–ü—Ä–∏–≤–µ—Ç! –Ø TerraBot, —É—Å–∏–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º Gemini. –°–ø—Ä–∞—à–∏–≤–∞–π –æ —á–µ–º —É–≥–æ–¥–Ω–æ! üåç");

          }, 800);

      }



      function initMap() {

          map = L.map('map', {  

              center: [20, 0], zoom: 3, minZoom: 2, zoomControl: false, attributionControl: false,

              maxBounds: [[-85, -180], [85, 180]], maxBoundsViscosity: 1.0

          });

          tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { noWrap: true }).addTo(map);

          map.on('click', e => fetchInfo(e.latlng.lat, e.latlng.lng));

      }



      function addVote(type) {

          db.ref(type === 'like' ? 'votes/likes' : 'votes/dislikes').transaction(c => (c || 0) + 1);

          document.getElementById('vote-controls').style.display = 'none';

          document.getElementById('rat-text').innerText = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ! ‚ù§Ô∏è";

          document.getElementById('rat-bot').classList.add('cute');

          setTimeout(() => { document.getElementById('rating-widget').style.opacity = '0'; }, 3000);

      }



      // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–ë–†–ê–ë–û–¢–ö–ê –ò–ò

      async function askGemini(prompt) {

           const loader = document.getElementById("loader");

           if (loader) loader.style.display = "block"; 



           try {

               const response = await fetch("/api/chat", {

                   method: "POST",

                   headers: { "Content-Type": "application/json" },

                   body: JSON.stringify({ prompt: prompt })

               });



               const data = await response.json();

               if (loader) loader.style.display = "none"; 



               if (response.ok && data.choices && data.choices[0]) {

                   return data.choices[0].message.content;

               } else {

                   return "[–û—à–∏–±–∫–∞]: –ë–æ—Ç –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–ª. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.";

               }

           } catch (e) {

               if (loader) loader.style.display = "none";

               return "[–û—à–∏–±–∫–∞ —Å–µ—Ç–∏]: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.";

           }

      }



      async function sendChat() {

          const input = document.getElementById('chat-input');

          const log = document.getElementById('chat-log');

          const q = input.value.trim();

          if(!q) return;

           

          log.innerHTML += `<div class="bubble user-msg">${q}</div>`;

          input.value = '';

          log.scrollTop = log.scrollHeight;



          if(q === '/ali09') {

              typeMessage(`üõ† ADMIN\nüëç Likes: ${stats.likes}\nüëé Dislikes: ${stats.dislikes}`);

              return;

          }



          let aiResponse = await askGemini(`–¢—ã –≥–∏–¥-–≥–µ–æ–≥—Ä–∞—Ñ TerraBot. –ö—Ä–∞—Ç–∫–æ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: ${q}`);



          try {

              const wikiSearch = await fetch(`https://ru.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(q)}&limit=1&format=json&origin=*`).then(r=>r.json());

              let searchName = (wikiSearch[1] && wikiSearch[1][0]) ? wikiSearch[1][0] : q;

              const search = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchName)}&limit=1&accept-language=ru`).then(r=>r.json());

               

              if(search[0]) {

                  const {lat, lon} = search[0];

                  map.flyTo([lat, lon], 9);

                  fetchInfo(lat, lon);

              }

              typeMessage(aiResponse || "–•–º–º, –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —ç—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å!");

          } catch(e) { typeMessage("–£–ø—Å, —Å–±–∏–ª—Å—è –ø—Ä–∏—Ü–µ–ª! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑."); }

      }



      function typeMessage(text) {

          const log = document.getElementById('chat-log');

          const bubble = document.createElement('div');

          bubble.className = 'bubble ai-msg typing';

          log.appendChild(bubble);

          let i = 0;

          function type() {

              if (i < text.length) {

                  bubble.innerHTML += text.charAt(i); i++; log.scrollTop = log.scrollHeight; setTimeout(type, 15);

              } else { bubble.classList.remove('typing'); }

          }

          type();

      }



      async function fetchInfo(lat, lon) {

          document.getElementById('info-card').classList.add('active');

          try {

              const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`).then(r=>r.json());

              const city = geo.address.city || geo.address.town || geo.address.state || "–¢–æ—á–∫–∞";

              document.getElementById('card-city').innerText = city;

              document.getElementById('card-country').innerText = geo.address.country || "";

              const code = geo.address.country_code?.toUpperCase();

              if(code) {

                  document.getElementById('card-flag').src = `https://flagsapi.com/${code}/flat/64.png`;

                  document.getElementById('card-flag').style.display = 'block';

                  const cData = await fetch(`https://restcountries.com/v3.1/alpha/${code}`).then(r=>r.json());

                  if(cData[0].currencies) {

                      const cur = Object.keys(cData[0].currencies)[0];

                      document.getElementById('card-curr').innerText = `${cur} (${cData[0].currencies[cur].symbol})`;

                  }

              }

              const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}¬§t_weather=true&timezone=auto`).then(r=>r.json());

              document.getElementById('card-temp').innerText = Math.round(w.current_weather.temperature) + "¬∞C";

              document.getElementById('card-utc').innerText = "UTC" + (w.utc_offset_seconds/3600 >= 0 ? "+" : "") + (w.utc_offset_seconds/3600);

              const time = new Date(new Date().getTime() + (new Date().getTimezoneOffset() * 60000) + (w.utc_offset_seconds * 1000));

              document.getElementById('card-time').innerText = time.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});

              const wiki = await fetch(`https://ru.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(city)}`).then(r=>r.json());

              document.getElementById('card-wiki').innerText = wiki.extract || "–î–µ—Ç–∞–ª—å–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç.";

          } catch(e) {}

      }



      function closeWindow(id) { document.getElementById(id).classList.remove('active'); }

      function toggleChat() { document.getElementById('chat-wrapper').classList.toggle('active'); }

      function setMode(m) {

          document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));

          document.getElementById(m === 'sat' ? 'btn-sat' : 'btn-map').classList.add('active');

          tileLayer.setUrl(m === 'sat' ? 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

      }

      async function globalSearch() {

          const q = document.getElementById('global-search').value;

          if(!q) return;

          const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`).then(res => res.json());

          if(r[0]) { map.flyTo([r[0].lat, r[0].lon], 10); fetchInfo(r[0].lat, r[0].lon); }

          document.getElementById('global-search').value = '';  

      }

      function toggleRoutePanel() { document.getElementById('route-panel').style.display = (document.getElementById('route-panel').style.display === 'flex' ? 'none' : 'flex'); }

      async function buildRoute() {

          const s = document.getElementById('start-inp').value, e = document.getElementById('end-inp').value;

          const r1 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${s}&limit=1`).then(r=>r.json());

          const r2 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e}&limit=1`).then(r=>r.json());

          if(r1[0] && r2[0]) {

              if(routingControl) map.removeControl(routingControl);

              routingControl = L.Routing.control({

                  waypoints: [L.latLng(parseFloat(r1[0].lat), parseFloat(r1[0].lon)), L.latLng(parseFloat(r2[0].lat), parseFloat(r2[0].lon))],

                  lineOptions: { styles: [{ color: '#3742fa', weight: 6, opacity: 0.8 }] },

                  createMarker: () => null, show: false

              }).addTo(map);

          }

      }

      function clearRoute() { if(routingControl) map.removeControl(routingControl); document.getElementById('start-inp').value = ''; document.getElementById('end-inp').value = ''; }

      document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendChat(); });



      // --- –õ–û–ì–ò–ö–ê –ú–ï–ù–Æ –ò –ú–û–î–ê–õ–û–ö ---

      function openMenu() { document.getElementById('main-menu').classList.add('open'); }

      function closeMenu() { document.getElementById('main-menu').classList.remove('open'); }



      function openModal(modalId) {

          closeMenu();

          document.getElementById('modal-overlay').classList.add('show');

          document.querySelectorAll('.custom-modal').forEach(m => m.classList.remove('show'));

          document.getElementById(modalId).classList.add('show');

      }



      function closeAllModals() {

          document.getElementById('modal-overlay').classList.remove('show');

          document.querySelectorAll('.custom-modal').forEach(m => {

              m.classList.remove('show');

              setTimeout(() => { if(!m.classList.contains('show')) m.style.display = 'none'; }, 300);

          });

      }



      document.querySelectorAll('.custom-modal').forEach(m => {

          m.addEventListener('transitionstart', function(e) {

              if (e.propertyName === 'opacity' && this.classList.contains('show')) {

                  this.style.display = 'block';

              }

          });

      });



      function setView(type) {

          let metaViewport = document.querySelector("meta[name=viewport]");

          if (type === 'mobile') {

              metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');

          } else if (type === 'desktop') {

              metaViewport.setAttribute('content', 'width=1200'); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ü–ö

          }

          closeAllModals();

      }

  </script>



</body>

</html>

