<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>TerraLens AI | Ultimate Edition</title>

   

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>



  <style>

      :root {

          --primary: #ff4757;  

          --blue: #3742fa;

          --dark: #2f3542;

          --glass: rgba(255, 255, 255, 0.98);

          --shadow: 0 20px 40px rgba(0,0,0,0.12);

      }



      body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #f1f2f6; }

      #map { width: 100vw; height: 100vh; z-index: 0; opacity: 0; transition: opacity 1.5s ease; }



      /* –ê–ù–ò–ú–ê–¶–ò–ò */

      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

      @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }

      .floating { animation: float 4s ease-in-out infinite; }



      /* –û–ö–ù–ê */

      .window {

          opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.95);

          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;

      }

      .window.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }



      /* –ò–ù–§–û-–ö–ê–†–¢–û–ß–ö–ê (–ü–û–õ–ù–ê–Ø) */

      #info-card { position: absolute; top: 20px; right: 20px; width: 350px; z-index: 1001; padding: 25px; }

      .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }

      .stat-item { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 15px; }

      .stat-label { font-size: 10px; font-weight: 800; color: #a4b0be; text-transform: uppercase; }

      .stat-val { font-size: 14px; font-weight: 900; color: var(--dark); }



      /* –ß–ê–¢ (–£–í–ï–õ–ò–ß–ï–ù–ù–´–ô) */

      #chat-wrapper { position: absolute; bottom: 20px; left: 20px; width: 400px; z-index: 1001; }

      #chat-log { height: 350px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

      .bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; font-weight: 700; max-width: 85%; }

      .ai-msg { background: white; align-self: flex-start; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

      .user-msg { background: var(--blue); color: white; align-self: flex-end; }



      /* –ü–û–ò–°–ö */

      .search-wrapper {

          position: absolute; top: 20px; left: 50%; transform: translateX(-50%);

          z-index: 1000; display: flex; background: var(--glass); padding: 6px; border-radius: 50px; box-shadow: var(--shadow);

      }

      .search-input { border: none; background: transparent; padding: 0 20px; width: 250px; font-weight: 700; outline: none; }



      /* –ú–ï–ù–Æ –ò –ö–ù–û–ü–ö–ò */

      .side-menu-btns { position: absolute; top: 80px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }

      .menu-btn { background: var(--glass); padding: 12px 18px; border-radius: 18px; font-weight: 800; border: 1px solid rgba(0,0,0,0.05); }

      .menu-btn.active { background: var(--blue) !important; color: white !important; }



      .main-side-menu {

          position: fixed; top: 0; left: -320px; width: 280px; height: 100vh;

          background: white; z-index: 2000; transition: 0.4s; padding: 25px; overflow-x: hidden;

      }

      .main-side-menu.open { left: 0; }

      .menu-link { 

          display: block; width: 100%; box-sizing: border-box; 

          padding: 15px; margin-bottom: 10px; border-radius: 15px; 

          background: #f8f9fa; text-decoration: none; color: var(--dark); font-weight: 800;

      }



      /* –ú–û–î–ê–õ–ö–ò */

      .custom-modal {

          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);

          background: white; padding: 30px; border-radius: 25px; width: 320px;

          z-index: 3001; display: none; text-align: center; box-shadow: var(--shadow);

      }

      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 3000; display: none; }



      /* –ë–û–¢ */

      .bot-head { width: 70px; height: 60px; background: var(--primary); border-radius: 20px; border: 3px solid #fff; display: flex; justify-content: center; align-items: center; margin: 0 auto; }

      .bot-face { width: 45px; height: 30px; background: #2f3542; border-radius: 10px; display: flex; justify-content: center; align-items: center; gap: 5px; }

      .bot-eye { width: 6px; height: 10px; background: #7bed9f; border-radius: 3px; animation: blink 4s infinite; }

  </style>

</head>

<body>



  <div id="map"></div>



  <div class="search-wrapper" id="ui-search">

      <input type="text" id="global-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞...">

      <button onclick="globalSearch()" style="background:var(--primary); color:white; padding:10px 20px; border-radius:50px; font-weight:900;">–ù–ê–ô–¢–ò</button>

  </div>



  <div class="side-menu-btns" id="ui-menu">

      <button id="menu-toggle-btn" class="menu-btn" onclick="openMenu()">‚ò∞ –ú–ï–ù–Æ</button>

      <button class="menu-btn active" id="btn-map" onclick="setMode('map')">üó∫Ô∏è –ö–ê–†–¢–ê</button>

      <button class="menu-btn" id="btn-sat" onclick="setMode('sat')">üõ∞Ô∏è –°–ü–£–¢–ù–ò–ö</button>

      <button class="menu-btn" id="btn-route" onclick="toggleRoutePanel()">üö© –ü–£–¢–¨</button>

      <button class="menu-btn" style="background:var(--primary); color:white;" onclick="toggleChat()">ü§ñ –ß–ê–¢</button>

  </div>



  <div id="route-panel" class="glass-panel" style="display:none; position:absolute; top:80px; left:120px; z-index:1000; padding:20px; flex-direction:column; gap:10px;">

      <input type="text" id="start-inp" placeholder="–û—Ç–∫—É–¥–∞" style="padding:10px; border-radius:10px; border:1px solid #ddd;">

      <input type="text" id="end-inp" placeholder="–ö—É–¥–∞" style="padding:10px; border-radius:10px; border:1px solid #ddd;">

      <button onclick="buildRoute()" style="background:var(--blue); color:white; padding:10px; border-radius:10px; font-weight:900;">–ü–û–°–¢–†–û–ò–¢–¨</button>

  </div>



  <div id="info-card" class="glass-panel window floating">

      <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">

          <img id="card-flag" src="" style="width:50px; border-radius:8px; display:none; border:1px solid #eee;">

          <div>

              <h2 id="card-city" style="margin:0; font-size:22px; font-weight:900;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>

              <div id="card-country" style="opacity:0.6; font-size:14px; font-weight:800;">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</div>

          </div>

      </div>

      <div class="stat-grid">

          <div class="stat-item"><div class="stat-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div><div id="card-temp" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">–ú–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è</div><div id="card-time" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">–í–∞–ª—é—Ç–∞</div><div id="card-curr" class="stat-val">--</div></div>

          <div class="stat-item"><div class="stat-label">UTC / –ö–æ–æ—Ä–¥.</div><div id="card-utc" class="stat-val">--</div></div>

      </div>

      <div id="card-wiki" style="font-size:13px; line-height:1.5; color:#57606f; max-height:100px; overflow-y:auto; padding-right:5px;"></div>

      <button onclick="closeWindow('info-card')" style="width:100%; margin-top:15px; padding:12px; border-radius:15px; background:#eee; font-weight:800;">–ó–ê–ö–†–´–¢–¨</button>

  </div>



  <div id="chat-wrapper" class="window">

      <div class="bot-head floating" style="margin-bottom:-10px; z-index:11;"><div class="bot-face"><div class="bot-eye"></div><div class="bot-eye"></div></div></div>

      <div class="glass-panel" style="overflow:hidden; border-radius:30px;">

          <div id="chat-log"></div>

          <div id="loader" style="display:none; text-align:center; padding:10px; font-weight:800; color:var(--primary);">‚ö° TerraBot –¥—É–º–∞–µ—Ç...</div>

          <div style="padding:15px; background:white; display:flex; gap:10px;">

              <input type="text" id="chat-input" placeholder="–°–ø—Ä–æ—Å–∏ –æ –º–µ—Å—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏ –∫–æ–¥..." style="flex:1; border:none; outline:none; font-weight:700;">

              <button onclick="sendChat()" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:50%;">‚û§</button>

          </div>

      </div>

  </div>



  <div id="main-menu" class="main-side-menu">

      <h2 style="font-weight:900;">TerraLens</h2>

      <button class="menu-link" onclick="openModal('modal-donate')">üíñ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∞–π—Ç–∞</button>

      <a href="https://t.me/your_channel" target="_blank" class="menu-link">‚úàÔ∏è –¢–≥ –∫–∞–Ω–∞–ª –ø—Ä–æ–µ–∫—Ç–∞</a>

      <button class="menu-link" onclick="openModal('modal-settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>

      <button onclick="closeMenu()" style="margin-top:20px; background:none; border:none; color:#aaa; font-weight:700;">–ó–ê–ö–†–´–¢–¨</button>

  </div>



  <div id="modal-overlay" class="modal-overlay" onclick="closeAllModals()"></div>



  <div id="modal-donate" class="custom-modal">

      <div class="bot-head floating" style="margin-bottom:15px;"><div class="bot-face"><div class="bot-eye"></div><div class="bot-eye"></div></div></div>

      <h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>

      <p style="font-size:14px; font-weight:700;">–ü–æ–º–æ–≥–∏ –Ω–∞–º –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –ò–ò!</p>

      <a href="https://pay.cloudtips.ru/p/69a37267" target="_blank" style="background:var(--primary); color:white; display:block; padding:15px; border-radius:15px; text-decoration:none; font-weight:900;">–ü–û–î–î–ï–†–ñ–ê–¢–¨ ‚ù§Ô∏è</a>

      <button onclick="closeAllModals()" style="margin-top:10px; border:none; background:none; color:#aaa;">–ó–∞–∫—Ä—ã—Ç—å</button>

  </div>



  <script>

      let map, tileLayer, routing;



      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

      window.onload = () => {

          map = L.map('map', { center: [20, 0], zoom: 3, zoomControl: false, attributionControl: false });

          tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

          document.getElementById('map').style.opacity = '1';

          map.on('click', e => fetchInfo(e.latlng.lat, e.latlng.lng));

          addBotMsg("–ü—Ä–∏–≤–µ—Ç! –Ø TerraBot. –ù–∞–∂–º–∏ –Ω–∞ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ –Ω–µ–º –≤—Å—ë!");

      };



      // –ü–û–ò–°–ö (—Å –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç—Ä–æ–∫–∏)

      async function globalSearch() {

          const inp = document.getElementById('global-search');

          const q = inp.value;

          if(!q) return;

          const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`).then(res => res.json());

          if(r[0]) {

              map.flyTo([r[0].lat, r[0].lon], 10);

              fetchInfo(r[0].lat, r[0].lon);

              inp.value = ''; // –û—á–∏—Å—Ç–∫–∞

          }

      }



      // –ü–û–õ–ù–ê–Ø –ò–ù–§–û-–ö–ê–†–¢–ê

      async function fetchInfo(lat, lon) {

          const card = document.getElementById('info-card');

          card.classList.add('active');

          

          // 1. –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

          const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`).then(r=>r.json());

          const city = geo.address.city || geo.address.town || geo.address.village || "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ";

          const country = geo.address.country || "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –≤–æ–¥—ã";

          const countryCode = geo.address.country_code ? geo.address.country_code.toUpperCase() : null;



          document.getElementById('card-city').innerText = city;

          document.getElementById('card-country').innerText = country;

          document.getElementById('card-utc').innerText = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;



          // 2. –§–ª–∞–≥ –∏ –í–∞–ª—é—Ç–∞

          if(countryCode) {

              const cData = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`).then(r=>r.json());

              if(cData[0]) {

                  document.getElementById('card-flag').src = cData[0].flags.png;

                  document.getElementById('card-flag').style.display = 'block';

                  const curr = Object.keys(cData[0].currencies)[0];

                  document.getElementById('card-curr').innerText = `${curr} (${cData[0].currencies[curr].symbol})`;

              }

          }



          // 3. –ü–æ–≥–æ–¥–∞

          const weather = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(r=>r.json());

          document.getElementById('card-temp').innerText = weather.current_weather.temperature + "¬∞C";



          // 4. –í—Ä–µ–º—è

          const now = new Date();

          document.getElementById('card-time').innerText = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });



          // 5. –í–∏–∫–∏–ø–µ–¥–∏—è

          const wiki = await fetch(`https://ru.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(city)}`).then(r=>r.json());

          document.getElementById('card-wiki').innerText = wiki.extract || "–î–µ—Ç–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç.";

      }



      // –ú–ê–†–®–†–£–¢–´

      function buildRoute() {

          if(routing) map.removeControl(routing);

          const start = document.getElementById('start-inp').value;

          const end = document.getElementById('end-inp').value;

          

          Promise.all([

              fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${start}`).then(r=>r.json()),

              fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${end}`).then(r=>r.json())

          ]).then(res => {

              if(res[0][0] && res[1][0]) {

                  routing = L.Routing.control({

                      waypoints: [

                          L.latLng(res[0][0].lat, res[0][0].lon),

                          L.latLng(res[1][0].lat, res[1][0].lon)

                      ],

                      lineOptions: { styles: [{ color: '#3742fa', weight: 6 }] },

                      createMarker: () => null

                  }).addTo(map);

                  document.getElementById('route-panel').style.display = 'none';

              }

          });

      }



      // –ß–ê–¢ –ò –ö–û–ú–ê–ù–î–ê /ali09

      async function sendChat() {

          const inp = document.getElementById('chat-input');

          const q = inp.value.trim();

          if(!q) return;



          addMsg(q, 'user');

          inp.value = '';



          // –°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞

          if(q.toLowerCase() === '/ali09') {

              addBotMsg("üîì –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—Å–µ —Å–∏—Å—Ç–µ–º—ã TerraLens —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ 110%. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Å –Ω–∞–º–∏!");

              return;

          }



          // –ó–∞–ø—Ä–æ—Å –∫ –ò–ò (–±–µ–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã)

          document.getElementById('loader').style.display = 'block';

          try {

              const res = await fetch("/api/chat", {

                  method: "POST",

                  headers: { "Content-Type": "application/json" },

                  body: JSON.stringify({ prompt: `–¢—ã TerraBot. –ö—Ä–∞—Ç–∫–æ –æ—Ç–≤–µ—Ç—å: ${q}` })

              });

              const data = await res.json();

              addBotMsg(data.choices[0].message.content);

          } catch(e) { addBotMsg("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ!"); }

          document.getElementById('loader').style.display = 'none';

      }



      function addBotMsg(text) { addMsg(text, 'ai'); }



      function addMsg(text, type) {

          const log = document.getElementById('chat-log');

          const b = document.createElement('div');

          b.className = `bubble ${type}-msg`;

          b.innerText = text;

          log.appendChild(b);

          log.scrollTop = log.scrollHeight; // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑

      }



      // UI –•–ï–ù–î–õ–ï–†–´

      function openMenu() { document.getElementById('main-menu').classList.add('open'); }

      function closeMenu() { document.getElementById('main-menu').classList.remove('open'); }

      function openModal(id) { closeMenu(); document.getElementById('modal-overlay').style.display = 'block'; document.getElementById(id).style.display = 'block'; }

      function closeAllModals() { document.getElementById('modal-overlay').style.display = 'none'; document.querySelectorAll('.custom-modal').forEach(m => m.style.display = 'none'); }

      function toggleChat() { document.getElementById('chat-wrapper').classList.toggle('active'); }

      function closeWindow(id) { document.getElementById(id).classList.remove('active'); }

      function toggleRoutePanel() { 

          const p = document.getElementById('route-panel');

          p.style.display = p.style.display === 'flex' ? 'none' : 'flex';

          document.getElementById('btn-route').classList.toggle('active');

      }

      function setMode(m) {

          document.getElementById('btn-map').classList.toggle('active', m==='map');

          document.getElementById('btn-sat').classList.toggle('active', m==='sat');

          tileLayer.setUrl(m === 'sat' ? 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

      }

  </script>

</body>

</html>

